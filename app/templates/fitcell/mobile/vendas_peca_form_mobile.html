<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Venda de Peças</title>

<!-- BOOTSTRAP -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- SELECT2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet">

<!-- FONT AWESOME -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- CSS DO SISTEMA -->
<link rel="stylesheet" href="{{ url_for('static', filename='paginas3.css') }}">

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>

body{
  background:#eef4fb;
}

.mobile-container{
  padding:12px;
  max-width:520px;
  margin:auto;
}

.section-card{
  background:#fff;
  border-radius:18px;
  padding:16px;
  box-shadow:0 8px 22px rgba(0,0,0,.08);
  margin-bottom:14px;
}

.total-box{
  font-size:22px;
  font-weight:700;
}

</style>

</head>

<body>

<div class="mobile-container">

{% include '_flash_messages.html' %}

<!-- HEADER -->

<div class="d-flex align-items-center gap-2 mb-3">

<div style="
width:42px;
height:42px;
border-radius:14px;
background:#0d6efd;
color:white;
display:flex;
align-items:center;
justify-content:center;">
<i class="fa-solid fa-cart-shopping"></i>
</div>

<strong style="font-size:18px">Venda de Peças</strong>

</div>

<form method="POST">

{{ form.csrf_token }}

<!-- DADOS -->

<div class="section-card">

<div class="mb-2">
{{ form.modelo_celular_id.label(class="form-label") }}
<select name="{{ form.modelo_celular_id.name }}"
id="{{ form.modelo_celular_id.id }}"
class="form-control select2"
onchange="filtrarPecas(this.value)">
<option value="">Modelo</option>
{% for value,label in form.modelo_celular_id.choices %}
<option value="{{value}}" {% if form.modelo_celular_id.data==value %}selected{% endif %}>
{{label}}
</option>
{% endfor %}
</select>
</div>

<div class="mb-2">
{{ form.cliente_nome.label(class="form-label") }}
{{ form.cliente_nome(class="form-control") }}
</div>

<div class="mb-2">
{{ form.cliente_telefone.label(class="form-label") }}
{{ form.cliente_telefone(class="form-control") }}
</div>

<div class="mb-2">
{{ form.tipo_pagamento.label(class="form-label") }}
{{ form.tipo_pagamento(class="form-control") }}
</div>

<div class="mb-2">
{{ form.desconto.label(class="form-label") }}
{{ form.desconto(class="form-control",step="0.01",onchange="calcularTotal()") }}
</div>

</div>

<!-- ITENS -->

<div id="lista-itens"></div>

<button type="button"
class="btn btn-success w-100 mb-3"
onclick="adicionarLinha()">
<i class="fa fa-plus"></i> Adicionar Peça
</button>

<!-- TOTAL -->

<div class="section-card">

<label>Total da Venda</label>
<input id="total_venda" class="form-control total-box" readonly>

<div class="d-grid gap-2 mt-3">

<button type="submit" class="btn btn-success">
Finalizar Venda
</button>

<button type="button" class="btn btn-primary" onclick="receberViaPix()">
<i class="fa-brands fa-pix"></i> Pix
</button>

<a href="{{ url_for('routes.fitcell_listar_vendas_pecas_mobile') }}" class="btn btn-secondary">
Cancelar
</a>

</div>

</div>

</form>

</div>

<script>

let contador=0;

function filtrarPecas(id){
if(id) location.href='?modelo_id='+id;
}

function adicionarLinha(){

contador++;

const div=document.createElement("div");
div.className="section-card";
div.dataset.idx=contador;

div.innerHTML=`

<select name="peca_id[]" class="form-control select2 mb-2">
<option value="">Selecione a peça</option>
{% for p in pecas %}
<option value="{{p.id}}" data-preco="{{p.preco_venda}}">
{{p.codigo_interno}} - {{p.nome}}
</option>
{% endfor %}
</select>

<div class="mb-1 text-muted" style="font-size:13px">
Qtd / Valor
</div>

<div class="d-flex gap-2 mb-2">

<input type="number"
name="quantidade[]"
class="form-control"
placeholder="Qtd"
value="1"
onchange="calcularLinha(this)">

<input type="number"
step="0.01"
name="valor_unitario[]"
class="form-control"
placeholder="Valor"
onchange="calcularLinha(this)">

</div>

<div class="d-flex justify-content-between align-items-center">

<strong>Subtotal</strong>

<div class="d-flex gap-2">

<input class="form-control total-linha"
style="max-width:130px"
readonly>

<button type="button"
class="btn btn-danger btn-sm"
onclick="removerLinha(${contador})">
<i class="fa fa-trash"></i>
</button>

</div>

</div>
`;

document.getElementById("lista-itens").appendChild(div);
initSelect2();
}

function removerLinha(i){
document.querySelector(`[data-idx="${i}"]`)?.remove();
calcularTotal();
}

function calcularLinha(el){
const card=el.closest(".section-card");
const q=card.querySelector('[name="quantidade[]"]').value||0;
const v=card.querySelector('[name="valor_unitario[]"]').value||0;
card.querySelector(".total-linha").value=(q*v).toFixed(2);
calcularTotal();
}

function calcularTotal(){
let t=0;
document.querySelectorAll(".total-linha").forEach(e=>t+=parseFloat(e.value||0));
let d=parseFloat(document.querySelector('[name="desconto"]').value||0);
document.getElementById("total_venda").value=(t-d).toFixed(2);
}

function initSelect2(){
$('.select2').select2({
theme:'bootstrap-5',
width:'100%'
}).on('select2:select',function(e){
const preco=e.params.data.element.dataset.preco;
const card=this.closest(".section-card");
if(preco){
card.querySelector('[name="valor_unitario[]"]').value=preco;
calcularLinha(card.querySelector('[name="valor_unitario[]"]'));
}
});
}

$(function(){initSelect2();});

function receberViaPix(){
const f=document.querySelector("form");
f.action="{{ url_for('routes.fitcell_receber_via_pix_mobile') }}";
f.submit();
}

</script>

</body>
</html>
