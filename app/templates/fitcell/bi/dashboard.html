<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Dashboard Fitcell</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">



  <style>
    body {
      background: radial-gradient(circle at top, #0d1b2a, #000814);
      color: #fff;
      font-family: Inter, system-ui, Arial, sans-serif;
    }

    .card-dark {
      background: linear-gradient(145deg, #0b132b, #020617);
      border-radius: 16px;
      padding: 20px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .05);
    }

    .kpi-title {
      font-size: 13px;
      opacity: .85;
    }

    .kpi-value {
      font-size: 28px;
      font-weight: 700;
    }
  </style>
</head>

<body>

  <div class="container-fluid p-4">

    <h3 class="mb-4 fw-bold">Dashboard Fitcell</h3>

    <!-- Filtros -->
    <form method="GET" class="row g-3 mb-4">
      <div class="col-md-3">
        <label class="form-label">De</label>
        <input type="date" name="data_ini" value="{{ data_ini }}" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label">At√©</label>
        <input type="date" name="data_fim" value="{{ data_fim }}" class="form-control">
      </div>

      <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-info w-100 fw-bold">Aplicar</button>
      </div>

      <div class="col-md-3 d-flex align-items-end">
        <a href="{{ url_for('routes.home') }}" class="btn btn-outline-light w-100">
          ‚Üê Voltar
        </a>
      </div>
            <div class="col-md-3 d-flex align-items-end">
        <a href="{{ url_for('routes.fitcell_bi_dashboard') }}" class="btn btn-secondary w-100">
          <i class="fa-solid fa-rotate"></i> Atualizar
        </a>
      </div>
    </form>

    <!-- KPIs -->
    <div class="row g-3">

      <div class="col-md-3 col-6">
        <div class="card-dark">
          <div class="kpi-title">Quantidade Vendida</div>
          <div id="kpi-qtd-vendida" class="kpi-value">‚Äî</div>
        </div>
      </div>

      <div class="col-md-3 col-6">
        <div class="card-dark">
          <div class="kpi-title">Valor Vendido</div>
          <div id="kpi-valor-vendido" class="kpi-value">‚Äî</div>
        </div>
      </div>

      <div class="col-md-3 col-6">
        <div class="card-dark">
          <div class="kpi-title">Quantidade em Estoque</div>
          <div id="kpi-qtd-estoque" class="kpi-value">‚Äî</div>
        </div>
      </div>

      <div class="col-md-3 col-6">
        <div class="card-dark">
          <div class="kpi-title">Valor em Estoque</div>
          <div id="kpi-valor-estoque" class="kpi-value">‚Äî</div>
        </div>
      </div>

    </div>
    <div class="row g-4 mt-3">

      <!-- Vendido por dia -->
      <div class="col-md-6">
        <div class="card-dark">
          <h6 class="mb-3">Vendido por dia</h6>
          <canvas id="chartVendidoDia"></canvas>
        </div>
      </div>

      <!-- Top pe√ßas -->
      <div class="col-md-6">
        <div class="card-dark">
          <h6 class="mb-3">Top 5 pe√ßas vendidas</h6>
          <canvas id="chartTopPecas"></canvas>
        </div>
      </div>

    </div>


  </div>

<script>
  // üîπ par√¢metros do filtro (UMA VEZ S√ì)
  const params = new URLSearchParams(window.location.search).toString();

  // ==============================
  // üîπ KPIs
  // ==============================
  fetch(`/fitcell/bi/kpis?${params}`)
    .then(r => r.json())
    .then(d => {
      document.getElementById("kpi-qtd-vendida").innerText = d.qtd_vendida;
      document.getElementById("kpi-valor-vendido").innerText = d.valor_vendido;
      document.getElementById("kpi-qtd-estoque").innerText = d.qtd_estoque;
      document.getElementById("kpi-valor-estoque").innerText = d.valor_estoque;
    });

  // ==============================
  // üìà Vendido por dia (linha)
  // ==============================
  fetch(`/fitcell/bi/vendido-por-dia?${params}`)
    .then(r => r.json())
    .then(rows => {
      new Chart(document.getElementById("chartVendidoDia"), {
        type: "line",
        data: {
          labels: rows.map(r => r.dia),
          datasets: [{
            label: "R$ Vendido",
            data: rows.map(r => r.total),
            borderColor: "#22d3ee",
            backgroundColor: "rgba(34,211,238,.15)",
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              ticks: { color: "#94a3b8" },
              grid: { color: "rgba(255,255,255,.05)" }
            },
            y: {
              ticks: { color: "#94a3b8" },
              grid: { color: "rgba(255,255,255,.05)" }
            }
          }
        }
      });
    });

  // ==============================
  // üì¶ Top 5 pe√ßas vendidas (HORIZONTAL)
  // ==============================
  fetch(`/fitcell/bi/top-pecas?${params}`)
    .then(r => r.json())
    .then(rows => {
      new Chart(document.getElementById("chartTopPecas"), {
        type: "bar",
        data: {
          labels: rows.map(r => r.codigo),
          datasets: [{
            label: "Quantidade vendida",
            data: rows.map(r => r.quantidade),
            backgroundColor: "#22d3ee",
            borderRadius: 6
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (items) => {
                  const r = rows[items[0].dataIndex];
                  return r.nome || r.codigo;
                },
                label: (item) => `Quantidade vendida: ${item.raw}`
              }
            }
          },
          scales: {
            x: {
              ticks: { color: "#94a3b8" },
              grid: { color: "rgba(255,255,255,.05)" }
            },
            y: {
              ticks: { color: "#94a3b8" },
              grid: { display: false }
            }
          }
        }
      });
    });
</script>

</body>

</html>